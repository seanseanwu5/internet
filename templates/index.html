<!-- index.html -->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>BINGO遊戲</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(45deg, #3a7bd5, #00d2ff);
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        h1 {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px 0;
            margin: 0;
            font-size: 36px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #wrapper {
            width: 90%;
            max-width: 1200px;
            display: flex;
            flex-direction: row; /* 確保是水平排列 */
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 20px;
            margin: auto;
        }

        #content {
            flex: 1; /* 讓內容區塊自動填充可用空間 */
            padding: 20px;
        }

        #chat-container {
            flex: 0 0 300px; /* 固定聊天框寬度 */
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        #chat-messages {
            flex: 1; /* 讓聊天消息區域填充剩餘的垂直空間 */
            overflow-y: auto; /* 如果內容過多，允許滾動 */
            margin-bottom: 10px; /* 為輸入框留點空間 */
        }

        #chat-input, #send-message {
            margin-top: auto; /* 將輸入框和按鈕推到底部 */
        }

        h2, h3 {
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }

        #bingo-board, #bingo-board-game {
            margin: 0 auto;
            text-align: center;
        }

        #bingo-board td, #bingo-board-game td {
            width: 60px;
            height: 60px;
            line-height: 60px;
            border: 2px solid #3498db;
            font-size: 24px;
            cursor: pointer;
            background-color: #ecf0f1;
            transition: all 0.1s ease;
        }

        #bingo-board td:hover, #bingo-board-game td:hover {
            background-color: #bdc3c7;
        }

        #bingo-board-game .marked {
            background-color: #3498db;
            color: #fff;
            box-shadow: 0 0 10px #3498db;
        }

        #number-pool .number {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            margin: 5px;
            text-align: center;
            border: 2px solid #3498db;
            cursor: move;
            background-color: #fff;
            border-radius: 50%;
            transition: all 0.1s ease;
        }

        #number-pool .number:hover, #number-pool .number:active {
            background-color: #3498db;
            color: #fff;
        }

        #number-pool .number.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #player-list {
            border: 2px solid #3498db;
            padding: 10px;
            border-radius: 5px;
            background-color: #ecf0f1;
        }

        #timer {
            font-size: 28px;
            color: #e74c3c;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        #called-numbers .number {
            display: inline-block;
            width: 35px;
            height: 35px;
            line-height: 35px;
            margin: 2px;
            text-align: center;
            border: 1px solid #3498db;
            background-color: #bdc3c7;
            border-radius: 5px;
            transition: all 0.1s ease;
        }

        #called-numbers .number.called {
            background-color: #3498db;
            color: #fff;
            transform: scale(1.2);
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border-radius: 5px;
        }

        button:hover {
            background-color: #2980b9;
        }

        input[type="text"] {
            padding: 10px;
            border: 2px solid #3498db;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        #login, #game {
            background-color: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            animation: fadeIn 1s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 1000px) {
            #wrapper {
                flex-direction: column;
            }
            #content {
                margin-right: 0;
            }
            #chat-container {
                width: 100%;
                margin-top: 20px;
            }
            #chat-messages {
                height: 300px;
            }
        }

        @media (max-width: 767px) {
            .number {
                touch-action: none;
            }
        }
        .number {
            touch-action: none;
        }
    </style>
</head>
<body>
    <h1>BINGO 遊戲</h1>
    <div id="wrapper">
        <div id="content">
            <div id="login">
                <h2>請輸入您的訊息</h2>
                <label>用户名：</label>
                <input type="text" id="username"><br><br>
                <label>房間號：</label>
                <input type="text" id="room"><br><br>
                <button id="create-room">建立房間</button>
                <button id="join-room">加入房間</button>
            </div>
            <div id="game" style="display:none;">
                <h2>玩家：<span id="player-name"></span> | 房間：<span id="room-name"></span></h2>
                <div id="player-list">
                    <h3>當前玩家：</h3>
                    <ul id="players"></ul>
                </div>
                <div id="setup-board">
                    <h3>請拖放 1~25 的數字到下方的 BINGO 板</h3>
                    <div id="number-pool"></div>
                    <table id="bingo-board">
                        <tbody>
                            <tr>
                                <td></td><td></td><td></td><td></td><td></td>
                            </tr>
                            <tr>
                                <td></td><td></td><td></td><td></td><td></td>
                            </tr>
                            <tr>
                                <td></td><td></td><td></td><td></td><td></td>
                            </tr>
                            <tr>
                                <td></td><td></td><td></td><td></td><td></td>
                            </tr>
                            <tr>
                                <td></td><td></td><td></td><td></td><td></td>
                            </tr>
                        </tbody>
                    </table>
                    <button id="submit-board">提交板</button>
                </div>
                <div id="waiting" style="display:none;">
                    <h3>等待其他玩家...</h3>
                    <ul id="waiting-player-list"></ul>
                    <button id="start-game">開始遊戲</button>
                </div>
                <div id="bingo-game" style="display:none;">
                    <h3>輪到：<span id="current-player"></span></h3>
                    <h3>倒數計時：<span id="timer">15</span> 秒</h3>
                    <table id="bingo-board-game"></table>
                    <div id="called-numbers">
                        <h3>已被選擇的數字：</h3>
                        <div id="called-number-list"></div>
                    </div>
                </div>
                <div id="game-over" style="display:none;">
                    <h2>遊戲結束！</h2>
                    <p>獲勝者：<span id="winner-name"></span></p>
                    <button id="restart-game">重新開始</button>
                </div>
            </div>
        </div>
        <div id="chat-container">
            <h3>聊天</h3>
            <div id="chat-messages"></div>
            <input type="text" id="chat-input">
            <button id="send-message">發送</button>
        </div>
    </div>
    <script>
        var socket = io();
        var username;
        var room;
        var board = [];
        var marked = [];
        var isMyTurn = false;
        var timerInterval;
        var numbersCalled = [];

        $(function() {
            $('#create-room').click(function() {
                username = $('#username').val();
                room = $('#room').val();
                socket.emit('create_room', {'room': room, 'username': username});
                $('#player-name').text(username);
                $('#room-name').text(room);
                $('#login').hide();
                $('#game').show();
            });

            $('#join-room').click(function() {
                username = $('#username').val();
                room = $('#room').val();
                socket.emit('join_room', {'room': room, 'username': username});
                $('#player-name').text(username);
                $('#room-name').text(room);
                $('#login').hide();
                $('#game').show();
            });

            function generateNumberPool() {
                var pool = $('#number-pool');
                for (var i = 1; i <= 25; i++) {
                    var numDiv = $('<div></div>').addClass('number').text(i);
                    numDiv.draggable({
                        helper: 'clone',
                        revert: 'invalid'
                    });
                    // 添加長按事件
                    numDiv.on('touchstart', function(e) {
                        e.preventDefault();
                        var $this = $(this);
                        setTimeout(function() {
                            if ($this.is(':not(.disabled)')) {
                                $this.trigger('dragstart');
                            }
                        }, 500); // 500ms 後觸發拖動事件
                    });
                    pool.append(numDiv);
                }
            }

            function makeBoardDroppable() {
                $('#bingo-board td').droppable({
                    accept: '.number',
                    drop: function(event, ui) {
                        var number = ui.draggable.text();
                        if ($(this).text() !== '') {
                            var prevNumber = $(this).text();
                            // Enable the previous number
                            $('#number-pool .number').each(function() {
                                if ($(this).text() === prevNumber) {
                                    $(this).draggable('enable').removeClass('disabled');
                                }
                            });
                        }
                        $(this).text(number);
                        $(this).data('number', number);
                        // Disable the number in pool
                        ui.draggable.draggable('disable').addClass('disabled');
                    }
                });
            }
            $(function() {
                function generateNumberPool() {
                    var pool = $('#number-pool');
                    for (var i = 1; i <= 25; i++) {
                        var numDiv = $('<div></div>').addClass('number').text(i);
                        var hammer = new Hammer.Manager(numDiv[0], {
                            recognizers: [
                                [Hammer.Press, {time: 500}]
                            ]
                        });
                        hammer.on('press', function(e) {
                            var $this = $(e.target);
                            if ($this.is(':not(.disabled)')) {
                                $this.trigger('dragstart');
                            }
                        });
                        numDiv.draggable({
                            helper: 'clone',
                            revert: 'invalid',
                            start: function(event, ui) {
                                // 禁用滾動
                                $('body').css('overflow', 'hidden');
                            },
                            stop: function(event, ui) {
                                // 恢復滾動
                                $('body').css('overflow', 'auto');
                            }
                        });
                        pool.append(numDiv);
                    }
                }

                function makeBoardDroppable() {
                    $('#bingo-board td').droppable({
                        accept: '.number',
                        drop: function(event, ui) {
                            var number = ui.draggable.text();
                            if ($(this).text() !== '') {
                                var prevNumber = $(this).text();
                                // Enable the previous number
                                $('#number-pool .number').each(function() {
                                    if ($(this).text() === prevNumber) {
                                        $(this).draggable('enable').removeClass('disabled');
                                    }
                                });
                            }
                            $(this).text(number);
                            $(this).data('number', number);
                            // Disable the number in pool
                            ui.draggable.draggable('disable').addClass('disabled');
                        }
                    });
                }

                generateNumberPool();
                makeBoardDroppable();
            });
            $('#submit-board').click(function() {
                var numbers = [];
                var usedNumbers = {};
                $('#bingo-board td').each(function() {
                    var num = $(this).data('number');
                    if (!num) {
                        alert('請將所有數字填滿');
                        numbers = [];
                        return false;
                    }
                    num = parseInt(num);
                    if (usedNumbers[num]) {
                        alert('每個數字只能使用一次');
                        numbers = [];
                        return false;
                    }
                    usedNumbers[num] = true;
                    numbers.push(num);
                });
                if (numbers.length != 25) {
                    return;
                }
                board = numbers;
                marked = new Array(25).fill(false);
                socket.emit('submit_board', {'board': board});
                generateGameBoard();
                $('#setup-board').hide();
                $('#waiting').show();
            });

            $('#start-game').click(function() {
                socket.emit('start_game');
            });

            $('#send-message').click(function() {
                var message = $('#chat-input').val();
                if (message.trim() === '') return;
                socket.emit('send_message', {'message': message});
                $('#chat-input').val('');
            });

            // 添加 Enter 鍵發送消息功能
            $('#chat-input').keypress(function(e) {
                if (e.which == 13) { // 13 是 Enter 鍵的鍵碼
                    $('#send-message').click();
                }
            });

            $('#restart-game').click(function() {
                socket.emit('restart_game');
            });

            socket.on('update_player_list', function(data) {
                var list = $('#players');
                list.empty();
                data.players.forEach(function(player) {
                    list.append('<li>' + player + '</li>');
                });
            });

            socket.on('update_submission_status', function(data) {
                var status = data.submission_status;
                var list = $('#waiting-player-list');
                list.empty();
                for (var uname in status) {
                    var item = $('<li></li>').text(uname + (status[uname] ? ' 已完成' : ' 選擇中...'));
                    list.append(item);
                }
            });

            socket.on('game_started', function(data) {
                $('#waiting').hide();
                $('#bingo-game').show();
                generateAvailableNumbers();
                generateCalledNumbers();
            });

            socket.on('waiting_for_players', function(data) {
                alert(data.message);
            });

            socket.on('your_turn', function(data) {
                var current = data.username;
                $('#current-player').text(current);
                isMyTurn = (current == username);
                resetTimer();
            });

            socket.on('turn_skipped', function(data) {
                alert('玩家 ' + data.username + ' 超時，跳過他的回合');
            });

            socket.on('number_called', function(data) {
                var number = data.number;
                numbersCalled = data.numbers_called;
                updateCalledNumbers();
                var index = board.indexOf(number);
                if (index >= 0) {
                    marked[index] = true;
                    updateGameBoard();
                }
                if (data.winner) {
                    alert('玩家 ' + data.winner + ' 獲勝！');
                    isMyTurn = false;
                }
            });

            socket.on('game_over', function(data) {
                alert('遊戲結束！玩家 ' + data.winner + ' 獲勝！');
                $('#bingo-game').hide();
                $('#game-over').show();
                $('#winner-name').text(data.winner);
                isMyTurn = false;
            });

            socket.on('new_message', function(data) {
                $('#chat-messages').append('<div><strong>' + data.username + ':</strong> ' + data.message + '</div>');
                $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
            });

            socket.on('restart_game', function() {
                $('#game-over').hide();
                $('#setup-board').show();
                $('#waiting').hide();
                $('#bingo-game').hide();
                // 清空數字池並重新生成
                $('#number-pool').empty();
                generateNumberPool();
                // 清空 BINGO 板子
                $('#bingo-board td').each(function() {
                    $(this).text('').data('number', '');
                });
                board = [];
                marked = [];
                numbersCalled = [];
            });

            function generateGameBoard() {
                var table = $('#bingo-board-game');
                table.empty();
                for (var i = 0; i < 5; i++) {
                    var row = $('<tr></tr>');
                    for (var j = 0; j < 5; j++) {
                        var index = i * 5 + j;
                        var cell = $('<td></td>').text(board[index]);
                        cell.data('number', board[index]);
                        cell.data('index', index);
                        if (marked[index]) {
                            cell.addClass('marked');
                        }
                        cell.click(function() {
                            if (isMyTurn) {
                                var num = $(this).data('number');
                                if (numbersCalled.includes(num)) {
                                    alert('該數字已被選過');
                                    return;
                                }
                                socket.emit('number_selected', {'number': num});
                                isMyTurn = false;
                            }
                        });
                        row.append(cell);
                    }
                    table.append(row);
                }
            }

            function updateGameBoard() {
                $('#bingo-board-game td').each(function(index) {
                    if (marked[index]) {
                        $(this).addClass('marked');
                    }
                });
            }

            function resetTimer() {
                var timeLeft = 15;
                $('#timer').text(timeLeft);
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                timerInterval = setInterval(function() {
                    timeLeft--;
                    $('#timer').text(timeLeft);
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                    }
                }, 1000);
            }

            function generateAvailableNumbers() {
                var container = $('#available-numbers');
                container.empty();
                for (var i = 1; i <= 25; i++) {
                    var numDiv = $('<div></div>').addClass('number').text(i);
                    container.append(numDiv);
                }
            }

            function generateCalledNumbers() {
                var container = $('#called-number-list');
                container.empty();
                for (var i = 1; i <= 25; i++) {
                    var numDiv = $('<div></div>').addClass('number').text(i);
                    if (numbersCalled.includes(i)) {
                        numDiv.addClass('called');
                    }
                    container.append(numDiv);
                }
            }

            function updateCalledNumbers() {
                $('#called-number-list .number').each(function() {
                    var num = parseInt($(this).text());
                    if (numbersCalled.includes(num)) {
                        $(this).addClass('called');
                    }
                });
            }
        });
    </script>
</body>
</html>